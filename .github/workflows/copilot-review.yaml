# GitHub Copilot è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦GitHub Copilotã«ã‚ˆã‚‹è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¿ƒé€²ã—ã¾ã™ã€‚
name: Copilot Code Review

# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã¾ãŸã¯æ›´æ–°ã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ["main", "develop"]

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ¨©é™è¨­å®š
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 
  copilot-review-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: GitHub Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // PRã«Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            const prNumber = context.payload.pull_request.number;
            const existingComments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            // æ—¢ã«ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const reminderExists = existingComments.data.some(comment => 
              comment.body.includes('GitHub Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼')
            );
            
            if (!reminderExists) {
              const reviewMessage = [
                '## ğŸ¤– GitHub Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼',
                '',
                'ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ GitHub Copilot ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å¯¾è±¡ã§ã™ã€‚',
                '',
                '### ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ã™ã‚‹æ–¹æ³•:',
                '1. GitHubã®PRç”»é¢ã§ã€ŒReviewersã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ã',
                '2. ã€ŒCopilotã€ã‚’é¸æŠã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ',
                '',
                '### æ³¨æ„äº‹é …:',
                '- Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ—¥æœ¬èªã§ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã‚ˆã†è¨­å®šã•ã‚Œã¦ã„ã¾ã™',
                '- ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã‚’è¡Œã£ã¦ãã ã•ã„',
                '- è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯è£œåŠ©çš„ãªã‚‚ã®ã§ã™ã€‚äººé–“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚é‡è¦ã§ã™',
                '',
                'è©³ç´°ã¯ [GitHub Copilot Pull Request Reviews](https://docs.github.com/en/copilot/using-github-copilot/code-review/using-copilot-code-review) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚'
              ].join('\n');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: reviewMessage
              });
            }
